<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Conversation</title>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>

<h2 th:text="'Conversation avec ' + ${#strings.arrayJoin(nomsParticipants, ', ')}">Conversation</h2>

<!-- Affichage des messages -->
<div>
    <ul id="messages-list">
        <li th:each="message : ${messages}">
            <strong th:text="${message.expediteur.nomU + ' ' + message.expediteur.prenomU}">Auteur</strong> :
            <span th:text="${message.textM}">Texte</span>
            <small th:text="${#dates.format(message.dateM, 'dd/MM/yyyy HH:mm')}">Date</small>
        </li>
    </ul>
</div>

<!-- Formulaire pour envoyer un message -->
<form th:action="@{'/message/envoyer/' + ${conversation.idConv}}" method="post">
    <textarea name="texte" rows="3" required></textarea><br/>
    <button type="submit">Envoyer</button>
</form>

<!-- Lien retour -->
<p><a th:href="@{/user/mes-amis}">Retour Ã  mes amis</a></p>

<script th:inline="javascript">
    const conversationId = /*[[${conversation.idConv}]]*/ 0;
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);
    stompClient.debug = null;

    stompClient.connect({}, () => {
        stompClient.subscribe(`/topic/conversation/${conversationId}`, (message) => {
            const msg = JSON.parse(message.body);
            afficherMessage(msg);
        });
    });

    function afficherMessage(msg) {
        const list = document.getElementById("messages-list");
        const li = document.createElement("li");

        const auteur = document.createElement("strong");
        auteur.textContent = msg.expediteur.nomU + " " + msg.expediteur.prenomU;

        const contenu = document.createElement("span");
        contenu.textContent = " : " + msg.textM + " ";

        const date = document.createElement("small");
        const dateStr = new Date(msg.dateM).toLocaleString();
        date.textContent = dateStr;

        li.appendChild(auteur);
        li.appendChild(contenu);
        li.appendChild(date);

        list.appendChild(li);
    }
</script>

</body>
</html>
